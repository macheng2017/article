(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{218:function(e,a,n){"use strict";n.r(a);var t=n(0),s=Object(t.a)({},(function(){var e=this,a=e.$createElement,n=e._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"mongodb数据库添加密码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mongodb数据库添加密码"}},[e._v("#")]),e._v(" MongoDB数据库添加密码")]),e._v(" "),n("p",[e._v("配置角色 权限")]),e._v(" "),n("p",[e._v("四点认知")]),e._v(" "),n("pre",[n("code",[e._v("1. mongodb没有默认管理员账号,先添加管理员账号,在开启权限认证\n2. 只有切换到admin这个数据库之后添加的账号才算是管理员账号\n3. 用户只能在用户所在的数据库登录,包括管理员账号\n4. 管理员可以管理所有的数据库但是不能直接管理数据库,需要到admin认证后才可以\n")])]),e._v(" "),n("h2",{attrs:{id:"使用docker-compose"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用docker-compose"}},[e._v("#")]),e._v(" 使用docker-compose")]),e._v(" "),n("h3",{attrs:{id:"为什么要使用docker-compose"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为什么要使用docker-compose"}},[e._v("#")]),e._v(" 为什么要使用docker-compose")]),e._v(" "),n("p",[e._v("如果你是使用docker启动MongoDB auth的话,就有必要使用docker-compose")]),e._v(" "),n("pre",[n("code",[e._v("如果使用docker command line arguments 运行有个问题就是,第一次运行是不加auth验证的,\n设置完权限密码之后才能加上auth这样就导致,就会出现第二次不能启动同一个容器的问题,\n目前我没有找到解法,只有先用docker-compose 启动,这样不会第二次在重新开个容器\n")])]),e._v(" "),n("h3",{attrs:{id:"安装docker-compose"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装docker-compose"}},[e._v("#")]),e._v(" 安装docker-compose")]),e._v(" "),n("p",[e._v('如果按照官网教程,使用这个估计的吐血\nsudo curl -L "https://github.com/docker/compose/releases/download/1.25.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose')]),e._v(" "),n("p",[e._v("这里有个镜像网站,浪费了半个小时才想起来")]),e._v(" "),n("p",[n("a",{attrs:{href:"https://get.daocloud.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("DaoCloud | Docker 极速下载"),n("OutboundLink")],1)]),e._v(" "),n("p",[e._v("docker-compose.yml 默认保存在 ~下")]),e._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'2'")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("mongodb")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" mongo\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" m2\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" 27017"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("27017")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"./data/configdb:/data/configdb"')]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"./data/db:/data/db"')]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# command: mongod --auth")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# tty: true")]),e._v("\n")])])]),n("p",[e._v("运行")]),e._v(" "),n("p",[e._v("docker-compose up -d")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://juejin.im/post/5a560286f265da3e33043ab0",target:"_blank",rel:"noopener noreferrer"}},[e._v("docker创建带auth验证的mongodb数据库 - 掘金"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://medium.com/rahasak/enable-mongodb-authentication-with-docker-1b9f7d405a94",target:"_blank",rel:"noopener noreferrer"}},[e._v("Enable mongodb authentication with docker - Rahasak-Labs - Medium"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://blog.igevin.info/posts/docker-mongo-auth/",target:"_blank",rel:"noopener noreferrer"}},[e._v("基于Docker的MongoDB实现授权访问"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://docs.docker.com/compose/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Overview of Docker Compose | Docker Documentation"),n("OutboundLink")],1)])]),e._v(" "),n("p",[e._v("进入容器\ndocker -it exec m2 mongo bash")]),e._v(" "),n("p",[e._v("进入数据库并使用 admin\ndocker -it exec m2 mongo admin")]),e._v(" "),n("h2",{attrs:{id:"mongodb设置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mongodb设置"}},[e._v("#")]),e._v(" MongoDB设置")]),e._v(" "),n("h3",{attrs:{id:"设置超级管理员"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#设置超级管理员"}},[e._v("#")]),e._v(" 设置超级管理员")]),e._v(" "),n("p",[e._v("进入mongo 数据库 mongo --port xxx5")]),e._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[e._v("use admin\n\ndb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("createUser")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\nuser"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'xxxx_xxx_owner'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\npwd"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'xxxxxxxx'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\nroles"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\nrole"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'userAdminAnyDatabase'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\ndb"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v("'admin'")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n")])])]),n("p",[e._v("管理员可以间接管理所有数据库\n为什么是间接??")]),e._v(" "),n("p",[e._v("在admin数据库下进行授权")]),e._v(" "),n("pre",[n("code",[e._v("db.auth('xxxx_cases_owner','mima')\n")])]),e._v(" "),n("p",[e._v("切换到网站数据库")]),e._v(" "),n("pre",[n("code",[e._v("use xxxx-movie\n\ndb.createUser({user:'xxxx_runner',pwd:'mima',roles:[{\nrole:'readWrite',db:'xxxx-movie'\n}]})\n")])]),e._v(" "),n("p",[e._v("备份角色只能读")]),e._v(" "),n("pre",[n("code",[e._v("db.createUser({user:'xxxx_movie_wheel',pwd:'mima',roles:[{\nrole:'read',db:'xxxx-movie'\n}]})\n")])]),e._v(" "),n("p",[e._v("切换到admin数据库\n使用超级管理员 授权")]),e._v(" "),n("pre",[n("code",[e._v("use admin\ndb.auth('xxxx_cases_owner','mima')\n")])]),e._v(" "),n("p",[e._v("切换到需要操作的数据库")]),e._v(" "),n("pre",[n("code",[e._v("use xxxx-app\n")])]),e._v(" "),n("p",[e._v("复制上面的,修改下即可")]),e._v(" "),n("pre",[n("code",[e._v("db.createUser({user:'xxxx_app_runner',pwd:'mima',roles:[{\nrole:'readWrite',db:'xxxx-app'\n}]})\n")])]),e._v(" "),n("p",[e._v("备份角色只能读")]),e._v(" "),n("pre",[n("code",[e._v("db.createUser({user:'xxxx_app_wheel',pwd:'mima',roles:[{\nrole:'read',db:'xxxx-app'\n}]})\n")])]),e._v(" "),n("p",[e._v("切换到admin数据库\n使用超级管理员 授权")]),e._v(" "),n("pre",[n("code",[e._v("use admin\ndb.auth('xxxx_cases_owner','mima')\n")])]),e._v(" "),n("p",[e._v("切换到需要操作的数据库")]),e._v(" "),n("pre",[n("code",[e._v("use indust-app\n\ndb.createUser({user:'xxxx_app_runner',pwd:'mima',roles:[{\nrole:'readWrite',db:'xxxx-app'\n}]})\n")])]),e._v(" "),n("p",[e._v("备份角色只能读")]),e._v(" "),n("pre",[n("code",[e._v("db.createUser({user:'xxxx_app_wheel',pwd:'mima',roles:[{\nrole:'read',db:'xxxx-app'\n}]})\n")])]),e._v(" "),n("p",[e._v("开启")]),e._v(" "),n("pre",[n("code",[e._v("sudo vi /etc/mongod.conf\n\nsecurity:\nauthorization: 'enable'\n\nsudo service mongod restart\n")])]),e._v(" "),n("p",[e._v("先use admin 登录")]),e._v(" "),n("pre",[n("code",[e._v("use admin\ndb.auth('xxxx_cases_owner','mima')\n")])]),e._v(" "),n("p",[e._v("才能使用")]),e._v(" "),n("p",[e._v("链接数据库")]),e._v(" "),n("pre",[n("code",[e._v("mongo 127.0.0.1:38995/xxxx-movie -u imocc_movie_runner -p mima\n\n\nmkdir db\n\nmongodump -h 127.0.0.1:19999 -d indust-app -u indust_app_wheel -p mima -o indust-app-old\n")])]),e._v(" "),n("p",[e._v("打包")]),e._v(" "),n("pre",[n("code",[e._v("tar zcvf indust-app-old.tar.gz  indust-app-old/\n")])]),e._v(" "),n("p",[e._v("导出表")]),e._v(" "),n("pre",[n("code",[e._v("mongoexport -h 127.0.0.1:38995 -d xxxx_movie -u xxxx_movie_wheel -p mima -c users -q '{\"name\":{$ne:null} }' -o ./movie-users-old.json   \n")])]),e._v(" "),n("p",[e._v("下载\nscp -P 56666 root@120.xxxx.xxxx.200:/home/mac/db/indust-app-old.tar.gz ./")]),e._v(" "),n("pre",[n("code",[e._v("scp -P 56666 root@120.xxxx.xxxx.200:/home/mac/db/indust-app-old.json ./\n")])]),e._v(" "),n("p",[e._v("上传")]),e._v(" "),n("pre",[n("code",[e._v("scp -P 56666 ~/github/indust-app.tar.gz root@120.xxxx.xxxx.200:/home/root/dbbackup/\n")])]),e._v(" "),n("p",[e._v("正在运行的mongodb")]),e._v(" "),n("pre",[n("code",[e._v("mongo --port 38995\n\nuse admin \ndb.auth()\n\nuse xxxx_movie_target \n\n\n\ndb.createUser({user:'xxxx_movie_target',pwd:'mima',roles:[{\nrole:'readWrite',db:'xxxx_movie_target'\n}]})\n")])]),e._v(" "),n("p",[e._v("导入")]),e._v(" "),n("pre",[n("code",[e._v("mongorestore -h 127.0.0.1:19999 -d indust-app-target -u indust_app_target -p indust_target ./newdb/indust-app-old/indust-app\n")])])])}),[],!1,null,null,null);a.default=s.exports}}]);