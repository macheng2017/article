<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB数据库添加密码 | 马成的日志</title>
    <meta name="description" content="马成的日志">
    
    
    <link rel="preload" href="/assets/css/0.styles.3edbc46a.css" as="style"><link rel="preload" href="/assets/js/app.a9ab212a.js" as="script"><link rel="preload" href="/assets/js/2.4514bd47.js" as="script"><link rel="preload" href="/assets/js/10.6dedf7e5.js" as="script"><link rel="prefetch" href="/assets/js/11.45516bfc.js"><link rel="prefetch" href="/assets/js/12.11bce665.js"><link rel="prefetch" href="/assets/js/13.4449a1d2.js"><link rel="prefetch" href="/assets/js/14.b4c9bd9c.js"><link rel="prefetch" href="/assets/js/15.f619b43f.js"><link rel="prefetch" href="/assets/js/16.22cce3cf.js"><link rel="prefetch" href="/assets/js/17.e85694af.js"><link rel="prefetch" href="/assets/js/18.d16027c1.js"><link rel="prefetch" href="/assets/js/19.7fe78433.js"><link rel="prefetch" href="/assets/js/20.4931d07d.js"><link rel="prefetch" href="/assets/js/21.94bf61f1.js"><link rel="prefetch" href="/assets/js/22.35704660.js"><link rel="prefetch" href="/assets/js/23.f1ed7643.js"><link rel="prefetch" href="/assets/js/24.ff2801e8.js"><link rel="prefetch" href="/assets/js/25.c3d801cc.js"><link rel="prefetch" href="/assets/js/26.a3e6d133.js"><link rel="prefetch" href="/assets/js/27.432939de.js"><link rel="prefetch" href="/assets/js/28.f1460489.js"><link rel="prefetch" href="/assets/js/29.4eb2a704.js"><link rel="prefetch" href="/assets/js/3.bcd1ae82.js"><link rel="prefetch" href="/assets/js/30.b04eb895.js"><link rel="prefetch" href="/assets/js/31.93bfa56a.js"><link rel="prefetch" href="/assets/js/32.5cb6ba10.js"><link rel="prefetch" href="/assets/js/33.ae16d7ba.js"><link rel="prefetch" href="/assets/js/34.aaa226d3.js"><link rel="prefetch" href="/assets/js/35.c863814a.js"><link rel="prefetch" href="/assets/js/36.35ae20fd.js"><link rel="prefetch" href="/assets/js/37.a7da877f.js"><link rel="prefetch" href="/assets/js/38.52e05500.js"><link rel="prefetch" href="/assets/js/39.4505410f.js"><link rel="prefetch" href="/assets/js/4.e0a7a5e6.js"><link rel="prefetch" href="/assets/js/40.fb917143.js"><link rel="prefetch" href="/assets/js/41.5ec83de9.js"><link rel="prefetch" href="/assets/js/42.725572dd.js"><link rel="prefetch" href="/assets/js/43.d061c26d.js"><link rel="prefetch" href="/assets/js/44.df45f429.js"><link rel="prefetch" href="/assets/js/45.73541408.js"><link rel="prefetch" href="/assets/js/46.cf5996d0.js"><link rel="prefetch" href="/assets/js/5.63a71454.js"><link rel="prefetch" href="/assets/js/6.aa81e586.js"><link rel="prefetch" href="/assets/js/7.c158ba09.js"><link rel="prefetch" href="/assets/js/8.3639371a.js"><link rel="prefetch" href="/assets/js/9.b3d6674c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3edbc46a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">马成的日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <a href="https://github.com/macheng2017/article" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <a href="https://github.com/macheng2017/article" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>一些闪念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>每日定投(TheDailyRegularInvesting)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>读书笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/2019年3月18日 fork过来的仓库同步更简单方法.html" class="sidebar-link">2019年3月18日 fork过来的仓库同步更简单方法</a></li><li><a href="/book/MongoDB.html" class="active sidebar-link">MongoDB数据库添加密码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/MongoDB.html#使用docker-compose" class="sidebar-link">使用docker-compose</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/MongoDB.html#为什么要使用docker-compose" class="sidebar-link">为什么要使用docker-compose</a></li><li class="sidebar-sub-header"><a href="/book/MongoDB.html#安装docker-compose" class="sidebar-link">安装docker-compose</a></li></ul></li><li class="sidebar-sub-header"><a href="/book/MongoDB.html#mongodb设置" class="sidebar-link">MongoDB设置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/MongoDB.html#设置超级管理员" class="sidebar-link">设置超级管理员</a></li></ul></li></ul></li><li><a href="/book/coder.html" class="sidebar-link">程序员的思维修炼</a></li><li><a href="/book/deploy-mixinMessage.html" class="sidebar-link">部署mixin Message 大群笔记</a></li><li><a href="/book/docker.html" class="sidebar-link">学习使用docker-compose</a></li><li><a href="/book/go.html" class="sidebar-link">go语言读书笔记</a></li><li><a href="/book/lixiaolai.html" class="sidebar-link">/book/lixiaolai.html</a></li><li><a href="/book/logcic.html" class="sidebar-link">真相</a></li><li><a href="/book/springboot.html" class="sidebar-link">/book/springboot.html</a></li><li><a href="/book/vim.html" class="sidebar-link">vim的基本操作</a></li><li><a href="/book/web.html" class="sidebar-link">web</a></li><li><a href="/book/山川异域,风月同天.html" class="sidebar-link">“山川异域，风月同天”是什么意思？</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>pm2部署</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue学习笔记</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongodb数据库添加密码"><a href="#mongodb数据库添加密码" class="header-anchor">#</a> MongoDB数据库添加密码</h1> <p>配置角色 权限</p> <p>四点认知</p> <pre><code>1. mongodb没有默认管理员账号,先添加管理员账号,在开启权限认证
2. 只有切换到admin这个数据库之后添加的账号才算是管理员账号
3. 用户只能在用户所在的数据库登录,包括管理员账号
4. 管理员可以管理所有的数据库但是不能直接管理数据库,需要到admin认证后才可以
</code></pre> <h2 id="使用docker-compose"><a href="#使用docker-compose" class="header-anchor">#</a> 使用docker-compose</h2> <h3 id="为什么要使用docker-compose"><a href="#为什么要使用docker-compose" class="header-anchor">#</a> 为什么要使用docker-compose</h3> <p>如果你是使用docker启动MongoDB auth的话,就有必要使用docker-compose</p> <pre><code>如果使用docker command line arguments 运行有个问题就是,第一次运行是不加auth验证的,
设置完权限密码之后才能加上auth这样就导致,就会出现第二次不能启动同一个容器的问题,
目前我没有找到解法,只有先用docker-compose 启动,这样不会第二次在重新开个容器
</code></pre> <h3 id="安装docker-compose"><a href="#安装docker-compose" class="header-anchor">#</a> 安装docker-compose</h3> <p>如果按照官网教程,使用这个估计的吐血
sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.25.4/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</p> <p>这里有个镜像网站,浪费了半个小时才想起来</p> <p><a href="https://get.daocloud.io/" target="_blank" rel="noopener noreferrer">DaoCloud | Docker 极速下载<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>docker-compose.yml 默认保存在 ~下</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongodb</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> m2
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 27017<span class="token punctuation">:</span><span class="token number">27017</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;./data/configdb:/data/configdb&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;./data/db:/data/db&quot;</span>
    <span class="token comment"># command: mongod --auth</span>
    <span class="token comment"># tty: true</span>
</code></pre></div><p>运行</p> <p>docker-compose up -d</p> <ul><li><a href="https://juejin.im/post/5a560286f265da3e33043ab0" target="_blank" rel="noopener noreferrer">docker创建带auth验证的mongodb数据库 - 掘金<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/rahasak/enable-mongodb-authentication-with-docker-1b9f7d405a94" target="_blank" rel="noopener noreferrer">Enable mongodb authentication with docker - Rahasak-Labs - Medium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.igevin.info/posts/docker-mongo-auth/" target="_blank" rel="noopener noreferrer">基于Docker的MongoDB实现授权访问<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.docker.com/compose/" target="_blank" rel="noopener noreferrer">Overview of Docker Compose | Docker Documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>进入容器
docker -it exec m2 mongo bash</p> <p>进入数据库并使用 admin
docker -it exec m2 mongo admin</p> <h2 id="mongodb设置"><a href="#mongodb设置" class="header-anchor">#</a> MongoDB设置</h2> <h3 id="设置超级管理员"><a href="#设置超级管理员" class="header-anchor">#</a> 设置超级管理员</h3> <p>进入mongo 数据库 mongo --port xxx5</p> <div class="language-js extra-class"><pre class="language-js"><code>use admin

db<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
user<span class="token operator">:</span> <span class="token string">'xxxx_xxx_owner'</span><span class="token punctuation">,</span>
pwd<span class="token operator">:</span> <span class="token string">'xxxxxxxx'</span><span class="token punctuation">,</span>
roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
role<span class="token operator">:</span> <span class="token string">'userAdminAnyDatabase'</span><span class="token punctuation">,</span>
db<span class="token operator">:</span> <span class="token string">'admin'</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>管理员可以间接管理所有数据库
为什么是间接??</p> <p>在admin数据库下进行授权</p> <pre><code>db.auth('xxxx_cases_owner','mima')
</code></pre> <p>切换到网站数据库</p> <pre><code>use xxxx-movie

db.createUser({user:'xxxx_runner',pwd:'mima',roles:[{
role:'readWrite',db:'xxxx-movie'
}]})
</code></pre> <p>备份角色只能读</p> <pre><code>db.createUser({user:'xxxx_movie_wheel',pwd:'mima',roles:[{
role:'read',db:'xxxx-movie'
}]})
</code></pre> <p>切换到admin数据库
使用超级管理员 授权</p> <pre><code>use admin
db.auth('xxxx_cases_owner','mima')
</code></pre> <p>切换到需要操作的数据库</p> <pre><code>use xxxx-app
</code></pre> <p>复制上面的,修改下即可</p> <pre><code>db.createUser({user:'xxxx_app_runner',pwd:'mima',roles:[{
role:'readWrite',db:'xxxx-app'
}]})
</code></pre> <p>备份角色只能读</p> <pre><code>db.createUser({user:'xxxx_app_wheel',pwd:'mima',roles:[{
role:'read',db:'xxxx-app'
}]})
</code></pre> <p>切换到admin数据库
使用超级管理员 授权</p> <pre><code>use admin
db.auth('xxxx_cases_owner','mima')
</code></pre> <p>切换到需要操作的数据库</p> <pre><code>use indust-app

db.createUser({user:'xxxx_app_runner',pwd:'mima',roles:[{
role:'readWrite',db:'xxxx-app'
}]})
</code></pre> <p>备份角色只能读</p> <pre><code>db.createUser({user:'xxxx_app_wheel',pwd:'mima',roles:[{
role:'read',db:'xxxx-app'
}]})
</code></pre> <p>开启</p> <pre><code>sudo vi /etc/mongod.conf

security:
authorization: 'enable'

sudo service mongod restart
</code></pre> <p>先use admin 登录</p> <pre><code>use admin
db.auth('xxxx_cases_owner','mima')
</code></pre> <p>才能使用</p> <p>链接数据库</p> <pre><code>mongo 127.0.0.1:38995/xxxx-movie -u imocc_movie_runner -p mima


mkdir db

mongodump -h 127.0.0.1:19999 -d indust-app -u indust_app_wheel -p mima -o indust-app-old
</code></pre> <p>打包</p> <pre><code>tar zcvf indust-app-old.tar.gz  indust-app-old/
</code></pre> <p>导出表</p> <pre><code>mongoexport -h 127.0.0.1:38995 -d xxxx_movie -u xxxx_movie_wheel -p mima -c users -q '{&quot;name&quot;:{$ne:null} }' -o ./movie-users-old.json   
</code></pre> <p>下载
scp -P 56666 root@120.xxxx.xxxx.200:/home/mac/db/indust-app-old.tar.gz ./</p> <pre><code>scp -P 56666 root@120.xxxx.xxxx.200:/home/mac/db/indust-app-old.json ./
</code></pre> <p>上传</p> <pre><code>scp -P 56666 ~/github/indust-app.tar.gz root@120.xxxx.xxxx.200:/home/root/dbbackup/
</code></pre> <p>正在运行的mongodb</p> <pre><code>mongo --port 38995

use admin 
db.auth()

use xxxx_movie_target 



db.createUser({user:'xxxx_movie_target',pwd:'mima',roles:[{
role:'readWrite',db:'xxxx_movie_target'
}]})
</code></pre> <p>导入</p> <pre><code>mongorestore -h 127.0.0.1:19999 -d indust-app-target -u indust_app_target -p indust_target ./newdb/indust-app-old/indust-app
</code></pre></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/macheng2017/article/edit/master/docs/book/MongoDB.md" target="_blank" rel="noopener noreferrer">帮我改善此文章</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">3/4/2020, 7:37:16 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/2019年3月18日 fork过来的仓库同步更简单方法.html" class="prev">2019年3月18日 fork过来的仓库同步更简单方法</a></span> <span class="next"><a href="/book/coder.html">程序员的思维修炼</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a9ab212a.js" defer></script><script src="/assets/js/2.4514bd47.js" defer></script><script src="/assets/js/10.6dedf7e5.js" defer></script>
  </body>
</html>
